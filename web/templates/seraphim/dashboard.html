<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: false }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Chart.js for price charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    
    <!-- WebSocket for real-time data -->
    <script>
        const wsScheme = window.location.protocol == "https:" ? "wss" : "ws";
        const wsPath = wsScheme + '://' + window.location.host + '/ws/ticks/';
    </script>
    
    <!-- Chart update with destroy+rebuild strategy -->
    <script>
        // Global chart references
        window.priceChart = null;
        window.volumeChart = null;
        
        // Update function that Alpine.js can call
        window.updatePriceChart = function(symbol, interval) {
            fetch(`/api/market-data/?symbol=${symbol}&interval=${interval}`)
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    if (window.priceChart) {
                        window.priceChart.destroy();
                    }
                    if (window.volumeChart) {
                        window.volumeChart.destroy();
                    }
                    
                    // Prepare candlestick data
                    const candleData = data.ohlc.map(item => ({
                        x: new Date(item.timestamp).getTime(),
                        o: parseFloat(item.open),
                        h: parseFloat(item.high),
                        l: parseFloat(item.low),
                        c: parseFloat(item.close)
                    })).reverse(); // Oldest to newest
                    
                    // Prepare EMA Channel data
                    const emaHighData = data.indicators.map(ind => ({
                        x: new Date(ind.unix * 1000).getTime(),
                        y: ind.ema_high_33 ? parseFloat(ind.ema_high_33) : null
                    })).reverse();
                    
                    const emaLowData = data.indicators.map(ind => ({
                        x: new Date(ind.unix * 1000).getTime(),
                        y: ind.ema_low_33 ? parseFloat(ind.ema_low_33) : null
                    })).reverse();
                    
                    // Determine time unit
                    const timeUnit = interval === '3600' ? 'hour' : interval === '14400' ? 'hour' : 'day';
                    
                    // Create price chart with candlesticks and EMA Channel
                    const priceCtx = document.getElementById('priceChart').getContext('2d');
                    window.priceChart = new Chart(priceCtx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: symbol,
                                data: candleData,
                                color: {
                                    up: '#10b981',
                                    down: '#ef4444',
                                    unchanged: '#6b7280'
                                },
                                borderColor: {
                                    up: '#059669',
                                    down: '#dc2626',
                                    unchanged: '#4b5563'
                                }
                            }, {
                                label: '上轨当值 (EMA High 33)',
                                type: 'line',
                                data: emaHighData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            }, {
                                label: '下轨当值 (EMA Low 33)',
                                type: 'line',
                                data: emaLowData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: '-1' // Fill between this line and previous
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            if (context.dataset.type === 'candlestick') {
                                                const data = context.parsed;
                                                return [
                                                    `Open: $${data.o?.toFixed(2) || 'N/A'}`,
                                                    `High: $${data.h?.toFixed(2) || 'N/A'}`,
                                                    `Low: $${data.l?.toFixed(2) || 'N/A'}`,
                                                    `Close: $${data.c?.toFixed(2) || 'N/A'}`
                                                ];
                                            } else {
                                                return `${context.dataset.label}: $${context.parsed.y?.toFixed(2) || 'N/A'}`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: timeUnit,
                                        displayFormats: {
                                            hour: 'MMM dd HH:mm',
                                            day: 'MMM dd'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Create volume chart
                    const volumeData = data.ohlc.map(item => ({
                        x: new Date(item.timestamp).getTime(),
                        y: parseFloat(item.volume || 0)
                    })).reverse();
                    
                    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
                    window.volumeChart = new Chart(volumeCtx, {
                        type: 'bar',
                        data: {
                            datasets: [{
                                label: 'Volume',
                                data: volumeData,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: timeUnit
                                    },
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => console.error('Chart update error:', err));
        };
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300" x-data="tradingDashboard()">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                        🔥 Seraphim Trading
                    </h1>
                </div>
                
                <!-- Navigation Items -->
                <div class="flex items-center space-x-4">
                    <!-- Connection Status -->
                    <div class="flex items-center space-x-4">
                        <!-- WebSocket Status -->
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                            <span class="text-sm text-gray-600 dark:text-gray-300" x-text="wsConnected ? 'WS Live' : 'WS Offline'"></span>
                        </div>
                        
                        <!-- Kraken Integration Status -->
                        {% if kraken_integration %}
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2 bg-blue-500"></span>
                            <span class="text-sm text-blue-600 dark:text-blue-400">
                                Kraken ({{ kraken_live_count }} live)
                            </span>
                        </div>
                        {% endif %}

                        <!-- IBKR Integration Status -->
                        {% if ibkr_integration %}
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2 bg-green-500"></span>
                            <span class="text-sm text-green-600 dark:text-green-400">
                                IBKR ({{ ibkr_live_count }} stocks)
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <button 
                        @click="darkMode = !darkMode"
                        class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                    >
                        <span x-show="!darkMode">🌙</span>
                        <span x-show="darkMode">☀️</span>
                    </button>
                    
                    {% if is_authenticated %}
                        <span class="text-gray-700 dark:text-gray-300">{{ user.username }}</span>
                        <a href="{% url 'logout' %}" class="text-red-600 hover:text-red-700">Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Market Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Market Overview</h2>
            
            <!-- Price Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {% for symbol in symbols_with_prices %}
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ symbol.name }}</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatPrice('{{ symbol.name }}', livePrice['{{ symbol.name }}'] || '{{ symbol.price|floatformat:2 }}')">
                                {% if symbol.price %}
                                    {% if symbol.name|slice:'-4:' == '/USD' or symbol.name == 'XAUUSD' or symbol.name == 'IAU' or symbol.name == 'TSLA' %}${% endif %}{{ symbol.price|floatformat:2 }}{% if symbol.name|slice:'-4:' == '/BTC' %} ₿{% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-right">
                            {% if symbol.price_source == 'Kraken Live' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
                                    🐙 Kraken Live
                                </span>
                            {% elif symbol.price_source == 'IBKR Live' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-800">
                                    📈 IBKR Live
                                </span>
                            {% elif 'IBKR (Connected' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
                                    🔌 IBKR Connected
                                </span>
                            {% elif 'IBKR' in symbol.price_source and 'Subscription' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">
                                    🔑 Subscription Required
                                </span>
                            {% elif 'BitStamp' in symbol.price_source or 'bitstamp' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 text-purple-800">
                                    🌊 BitStamp Live
                                </span>
                            {% elif symbol.price_source == 'database' or symbol.price_source == 'Historical DB' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">
                                    📚 Historical
                                </span>
                            {% elif symbol.price_source == 'live' or symbol.price_source == 'Redis' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-800">
                                    🔴 Live Cache
                                </span>
                            {% elif symbol.price_source == 'none' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-red-100 text-red-800">
                                    ❌ No Data
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">
                                    {{ symbol.price_source }}
                                </span>
                            {% endif %}
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="getPriceChangeClass('{{ symbol.name }}')">
                                    <span x-text="getPriceChange('{{ symbol.name }}')">--</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Trading Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Price Chart -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Price Chart</h3>
                    <div class="flex items-center space-x-4">
                        <!-- Time Interval Selector - Button Group Style -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-300">Interval:</label>
                            <div class="inline-flex rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden">
                                <button 
                                    @click="selectedInterval = '3600'; loadChartData()"
                                    :class="selectedInterval === '3600' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    1H
                                </button>
                                <button 
                                    @click="selectedInterval = '14400'; loadChartData()"
                                    :class="selectedInterval === '14400' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    4H
                                </button>
                                <button 
                                    @click="selectedInterval = '86400'; loadChartData()"
                                    :class="selectedInterval === '86400' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    1D
                                </button>
                                <button 
                                    @click="selectedInterval = '604800'; loadChartData()"
                                    :class="selectedInterval === '604800' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium">
                                    1W
                                </button>
                            </div>
                        </div>
                        <!-- Symbol Selector -->
                        <select x-model="selectedSymbol" @change="loadChartData()" 
                                class="rounded-md border-gray-300 text-sm focus:border-primary focus:ring-primary">
                            {% for symbol in symbols %}
                            <option value="{{ symbol.name }}">{{ symbol.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <!-- Main Price Chart -->
                <div class="h-64 mb-4">
                    <canvas id="priceChart"></canvas>
                </div>
                <!-- Volume Subplot -->
                <div class="h-24 border-t border-gray-200 dark:border-gray-600 pt-2">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Indicators (Always visible - no login required) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Technical Indicators</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">RSI (14)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.rsi || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">MACD</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.macd || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">SMA (20)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.sma_20 || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">EMA (12)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.ema_12 || '--'">--</span>
                    </div>
                    <!-- 轨道当值指标 -->
                    <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-300">上轨当值 (EMA High)</span>
                        <span class="text-sm font-bold text-blue-900 dark:text-blue-100" x-text="indicators.ema_high_33 || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900 rounded-lg border border-red-200 dark:border-red-700">
                        <span class="text-sm font-medium text-red-700 dark:text-red-300">下轨当值 (EMA Low)</span>
                        <span class="text-sm font-bold text-red-900 dark:text-red-100" x-text="indicators.ema_low_33 || '--'">--</span>
                    </div>
                    <!-- Last Closing Price -->
                    <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border-2 border-gray-300 dark:border-gray-600">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                            Last <span x-text="selectedInterval === '3600' ? '1H' : selectedInterval === '14400' ? '4H' : selectedInterval === '86400' ? '1D' : '1W'">1D</span> Closing
                        </span>
                        <span class="text-lg font-bold text-gray-900 dark:text-white" x-text="lastClosePrice || '--'">--</span>
                    </div>
                    <div class="text-center py-2 mt-4">
                        <span class="text-xs text-gray-500 dark:text-gray-400" 
                              x-text="`Based on latest ${selectedSymbol} ${selectedInterval === '3600' ? '1H' : selectedInterval === '14400' ? '4H' : selectedInterval === '86400' ? '1D' : '1W'} data`">
                            Based on latest data
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Status</h3>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">WebSocket</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Database</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Redis</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        function tradingDashboard() {
            return {
                selectedSymbol: 'BTC/USD',
                selectedInterval: '86400', // Default to 1D
                livePrice: {},
                indicators: {},
                lastClosePrice: '--',
                wsConnected: false,
                priceChart: null,
                volumeChart: null,
                socket: null,

            init() {
                this.initWebSocket();
                // V8: Chart initialization is in standalone script, but we trigger data load
                this.loadChartData();  // Load initial chart and indicators
                this.loadInitialPrices();
            },

            async loadInitialPrices() {
                // Load prices from server-side data  
                {% for symbol in symbols_with_prices %}
                {% if symbol.price %}
                this.livePrice['{{ symbol.name }}'] = this.formatPrice('{{ symbol.name }}', '{{ symbol.price|floatformat:2 }}');
                {% endif %}
                {% endfor %}
            },

                initWebSocket() {
                    try {
                        this.socket = new WebSocket(wsPath);
                        
                        this.socket.onopen = () => {
                            this.wsConnected = true;
                            // Subscribe to live price updates
                            this.socket.send(JSON.stringify({
                                event: "subscribe",
                                content: "ticker_price"
                            }));
                            this.socket.send(JSON.stringify({
                                event: "subscribe", 
                                content: "live_trades"
                            }));
                        };
                        
                        this.socket.onmessage = (event) => {
                            try {
                                // Check if data is JSON before parsing
                                if (typeof event.data !== 'string' || (!event.data.startsWith('{') && !event.data.startsWith('['))) {
                                    return;
                                }
                                
                                const data = JSON.parse(event.data);
                                this.updateLivePrice(data);
                            } catch (error) {
                                console.error('WebSocket error:', error);
                            }
                        };
                        
                        this.socket.onclose = () => {
                            this.wsConnected = false;
                            // Reconnect after 5 seconds
                            setTimeout(() => this.initWebSocket(), 5000);
                        };
                    } catch (error) {
                        console.error('WebSocket error:', error);
                    }
                },

                updateLivePrice(data) {
                    // Update live prices from WebSocket data
                    if (data.channel && data.data) {
                        // Handle live_trades_btcusd format
                        if (data.channel.startsWith('live_trades_')) {
                            const pairCode = data.channel.replace('live_trades_', '').toUpperCase();
                            // Convert btcusd to BTC/USD
                            let symbol;
                            if (pairCode.length === 6) {
                                symbol = pairCode.substr(0, 3) + '/' + pairCode.substr(3, 3);
                            } else if (pairCode === 'ETHBTC') {
                                symbol = 'ETH/BTC';
                            } else {
                                symbol = pairCode;
                            }
                            
                            const price = parseFloat(data.data.price_str || data.data.price).toFixed(2);
                            this.livePrice[symbol] = this.formatPrice(symbol, price);
                        }
                    }
                },

                getPriceChange(symbol) {
                    // Calculate price change percentage
                    // This would need historical data to calculate properly
                    return '+0.00%';
                },

                getPriceChangeClass(symbol) {
                    // Return CSS classes based on price change
                    return 'bg-gray-100 text-gray-800';
                },

                formatPrice(symbol, price) {
                    // Smart currency symbol formatting
                    if (!price || price === '--' || price === '') return '--';
                    
                    const numPrice = parseFloat(price.toString().replace(/[\$₿]/g, ''));
                    if (isNaN(numPrice)) return '--';
                    
                    // USD pairs get $ prefix
                    if (symbol.endsWith('/USD') || symbol === 'XAUUSD' || symbol === 'IAU' || symbol === 'TSLA') {
                        return '$' + numPrice.toFixed(2);
                    }
                    // BTC pairs get ₿ suffix  
                    else if (symbol.endsWith('/BTC')) {
                        return numPrice.toFixed(8) + ' ₿';
                    }
                    // Indices like DJI get no currency symbol
                    else if (symbol === 'DJI') {
                        return numPrice.toFixed(2);
                    }
                    // Default fallback (assume USD for stocks)
                    else {
                        return '$' + numPrice.toFixed(2);
                    }
                },

                async loadChartData() {
                    try {
                        const response = await fetch(`/api/market-data/?symbol=${this.selectedSymbol}&interval=${this.selectedInterval}`);
                        const data = await response.json();

                        // Update indicators panel
                        if (data.indicators && data.indicators.length > 0) {
                            const latest = data.indicators[0];
                            this.indicators = {
                                rsi: (latest.rsi !== null && latest.rsi !== undefined) ? Number(latest.rsi).toFixed(2) : '--',
                                macd: (latest.macd !== null && latest.macd !== undefined) ? Number(latest.macd).toFixed(4) : '--',
                                sma_20: (latest.sma_20 !== null && latest.sma_20 !== undefined) ? '$' + Number(latest.sma_20).toFixed(2) : '--',
                                ema_12: (latest.ema_12 !== null && latest.ema_12 !== undefined) ? '$' + Number(latest.ema_12).toFixed(2) : '--',
                                ema_high_33: (latest.ema_high_33 !== null && latest.ema_high_33 !== undefined) ? '$' + Number(latest.ema_high_33).toFixed(2) : '--',
                                ema_low_33: (latest.ema_low_33 !== null && latest.ema_low_33 !== undefined) ? '$' + Number(latest.ema_low_33).toFixed(2) : '--'
                            };
                        } else {
                            this.indicators = { rsi: '--', macd: '--', sma_20: '--', ema_12: '--', ema_high_33: '--', ema_low_33: '--' };
                        }
                        
                        // Update last closing price
                        if (data.ohlc && data.ohlc.length > 0) {
                            const latestOhlc = data.ohlc[0]; // API returns newest first
                            this.lastClosePrice = '$' + Number(latestOhlc.close).toFixed(2);
                        } else {
                            this.lastClosePrice = '--';
                        }

                        // Update chart
                        if (typeof window.updatePriceChart === 'function') {
                            window.updatePriceChart(this.selectedSymbol, this.selectedInterval);
                        }
                    } catch (error) {
                        console.error('Error loading chart data:', error);
                    }
                }
            }
        }
    </script>
</body>
</html>
