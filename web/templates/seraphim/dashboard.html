<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: false }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ app_name }}</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#8b5cf6',
                    }
                }
            }
        }
    </script>
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- Chart.js for price charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    
    <!-- WebSocket for real-time data -->
    <script>
        const wsScheme = window.location.protocol == "https:" ? "wss" : "ws";
        const wsPath = wsScheme + '://' + window.location.host + '/ws/ticks/';
    </script>
    
    <!-- Chart update with destroy+rebuild strategy -->
    <script>
        // Global chart references
        window.priceChart = null;
        window.volumeChart = null;
        
        // Update function that Alpine.js can call
        window.updatePriceChart = function(symbol, interval) {
            fetch(`/api/market-data/?symbol=${symbol}&interval=${interval}`)
                .then(r => r.json())
                .then(data => {
                    // Destroy existing charts
                    if (window.priceChart) {
                        window.priceChart.destroy();
                    }
                    if (window.volumeChart) {
                        window.volumeChart.destroy();
                    }
                    
                    // Prepare candlestick data
                    const candleData = data.ohlc.map(item => ({
                        x: new Date(item.timestamp).getTime(),
                        o: parseFloat(item.open),
                        h: parseFloat(item.high),
                        l: parseFloat(item.low),
                        c: parseFloat(item.close)
                    })).reverse(); // Oldest to newest
                    
                    // Prepare EMA Channel data
                    const emaHighData = data.indicators.map(ind => ({
                        x: new Date(ind.unix * 1000).getTime(),
                        y: ind.ema_high_33 ? parseFloat(ind.ema_high_33) : null
                    })).reverse();
                    
                    const emaLowData = data.indicators.map(ind => ({
                        x: new Date(ind.unix * 1000).getTime(),
                        y: ind.ema_low_33 ? parseFloat(ind.ema_low_33) : null
                    })).reverse();
                    
                    // Determine time unit
                    const timeUnit = interval === '3600' ? 'hour' : interval === '14400' ? 'hour' : 'day';
                    
                    // Create price chart with candlesticks and EMA Channel
                    const priceCtx = document.getElementById('priceChart').getContext('2d');
                    window.priceChart = new Chart(priceCtx, {
                        type: 'candlestick',
                        data: {
                            datasets: [{
                                label: symbol,
                                data: candleData,
                                color: {
                                    up: '#10b981',
                                    down: '#ef4444',
                                    unchanged: '#6b7280'
                                },
                                borderColor: {
                                    up: '#059669',
                                    down: '#dc2626',
                                    unchanged: '#4b5563'
                                }
                            }, {
                                label: '上轨当值 (EMA High 33)',
                                type: 'line',
                                data: emaHighData,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            }, {
                                label: '下轨当值 (EMA Low 33)',
                                type: 'line',
                                data: emaLowData,
                                borderColor: '#ef4444',
                                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: '-1' // Fill between this line and previous
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'top'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            if (context.dataset.type === 'candlestick') {
                                                const data = context.parsed;
                                                return [
                                                    `Open: $${data.o?.toFixed(2) || 'N/A'}`,
                                                    `High: $${data.h?.toFixed(2) || 'N/A'}`,
                                                    `Low: $${data.l?.toFixed(2) || 'N/A'}`,
                                                    `Close: $${data.c?.toFixed(2) || 'N/A'}`
                                                ];
                                            } else {
                                                return `${context.dataset.label}: $${context.parsed.y?.toFixed(2) || 'N/A'}`;
                                            }
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: timeUnit,
                                        displayFormats: {
                                            hour: 'MMM dd HH:mm',
                                            day: 'MMM dd'
                                        }
                                    },
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Create volume chart
                    const volumeData = data.ohlc.map(item => ({
                        x: new Date(item.timestamp).getTime(),
                        y: parseFloat(item.volume || 0)
                    })).reverse();
                    
                    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
                    window.volumeChart = new Chart(volumeCtx, {
                        type: 'bar',
                        data: {
                            datasets: [{
                                label: 'Volume',
                                data: volumeData,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            animation: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: timeUnit
                                    },
                                    grid: {
                                        display: false
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(156, 163, 175, 0.2)'
                                    }
                                }
                            }
                        }
                    });
                })
                .catch(err => console.error('Chart update error:', err));
        };
    </script>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300" x-data="tradingDashboard()">
    <!-- Navigation -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-white">
                        🔥 Seraphim Trading
                    </h1>
                </div>
                
                <!-- Navigation Items -->
                <div class="flex items-center space-x-4">
                    <!-- Connection Status -->
                    <div class="flex items-center space-x-4">
                        <!-- WebSocket Status -->
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></span>
                            <span class="text-sm text-gray-600 dark:text-gray-300" x-text="wsConnected ? 'WS Live' : 'WS Offline'"></span>
                        </div>
                        
                        <!-- Kraken Integration Status -->
                        {% if kraken_integration %}
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2 bg-blue-500"></span>
                            <span class="text-sm text-blue-600 dark:text-blue-400">
                                Kraken ({{ kraken_live_count }} live)
                            </span>
                        </div>
                        {% endif %}

                        <!-- IBKR Integration Status -->
                        {% if ibkr_integration %}
                        <div class="flex items-center">
                            <span class="w-2 h-2 rounded-full mr-2 bg-green-500"></span>
                            <span class="text-sm text-green-600 dark:text-green-400">
                                IBKR ({{ ibkr_live_count }} stocks)
                            </span>
                        </div>
                        {% endif %}
                    </div>
                    <button 
                        @click="darkMode = !darkMode"
                        class="p-2 rounded-lg text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                    >
                        <span x-show="!darkMode">🌙</span>
                        <span x-show="darkMode">☀️</span>
                    </button>
                    
                    {% if is_authenticated %}
                        <span class="text-gray-700 dark:text-gray-300">{{ user.username }}</span>
                        <a href="{% url 'logout' %}" class="text-red-600 hover:text-red-700">Logout</a>
                    {% else %}
                        <a href="{% url 'login' %}" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-600">Login</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <!-- Market Overview -->
        <div class="mb-8">
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Market Overview</h2>
            
            <!-- Price Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {% for symbol in symbols_with_prices %}
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-500 dark:text-gray-400">{{ symbol.name }}</p>
                            <p class="text-2xl font-bold text-gray-900 dark:text-white" x-text="formatPrice('{{ symbol.name }}', livePrice['{{ symbol.name }}'] || {{ symbol.price|default:'null' }})">
                                {% if symbol.price %}
                                    {{ symbol.price }}
                                {% else %}
                                    --
                                {% endif %}
                            </p>
                        </div>
                        <div class="text-right">
                            {% if symbol.price_source == 'Kraken Live' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
                                    🐙 Kraken Live
                                </span>
                            {% elif symbol.price_source == 'IBKR Live' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-800">
                                    📈 IBKR Live
                                </span>
                            {% elif 'IBKR (Connected' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-blue-100 text-blue-800">
                                    🔌 IBKR Connected
                                </span>
                            {% elif 'IBKR' in symbol.price_source and 'Subscription' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">
                                    🔑 Subscription Required
                                </span>
                            {% elif 'BitStamp' in symbol.price_source or 'bitstamp' in symbol.price_source %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-purple-100 text-purple-800">
                                    🌊 BitStamp Live
                                </span>
                            {% elif symbol.price_source == 'database' or symbol.price_source == 'Historical DB' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-gray-100 text-gray-800">
                                    📚 Historical
                                </span>
                            {% elif symbol.price_source == 'live' or symbol.price_source == 'Redis' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-green-100 text-green-800">
                                    🔴 Live Cache
                                </span>
                            {% elif symbol.price_source == 'none' %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-red-100 text-red-800">
                                    ❌ No Data
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded text-xs bg-yellow-100 text-yellow-800">
                                    {{ symbol.price_source }}
                                </span>
                            {% endif %}
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="getPriceChangeClass('{{ symbol.name }}')">
                                    <span x-text="getPriceChange('{{ symbol.name }}')">--</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Market Regime & Trading Signals -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Market Regime (Left Panel) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4">
                    市场状态 - <span x-text="selectedSymbol">BTC/USD</span>
                </h3>
                
                <!-- Market Type Indicator -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600 dark:text-gray-400">当前状态</span>
                        <span class="px-3 py-1 rounded-full text-sm font-medium"
                              :class="marketRegime.regime_type === 'trending' ? 
                                'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200' : 
                                'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'"
                              x-text="marketRegime.regime_type === 'trending' ? '📊 趋势市场' : '📈 震荡市场'">
                            --
                        </span>
                    </div>
                    
                    <!-- ADX Indicator -->
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600 dark:text-gray-400">趋势强度 (ADX)</span>
                        <div class="flex items-center">
                            <div class="w-32 h-2 bg-gray-200 dark:bg-gray-600 rounded-full mr-2">
                                <div class="h-2 bg-purple-600 rounded-full transition-all duration-300"
                                     :style="`width: ${Math.min((marketRegime.adx || 0), 100)}%`"></div>
                            </div>
                            <span class="text-sm font-bold" x-text="marketRegime.adx ? marketRegime.adx.toFixed(1) : '--'">--</span>
                        </div>
                    </div>
                    
                    <!-- Channel Stats -->
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm text-gray-600 dark:text-gray-400">轨道内时间</span>
                        <span class="text-sm font-mono" x-text="marketRegime.channel_in_pct ? marketRegime.channel_in_pct.toFixed(0) + '%' : '--'">--</span>
                    </div>
                </div>
                
                <!-- Multi-timeframe Analysis -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">多周期分析</h4>
                    <div class="space-y-2">
                        <template x-if="marketRegime.higher_timeframe">
                            <div class="flex items-center justify-between">
                                <span class="text-xs text-gray-600 dark:text-gray-400" 
                                      x-text="marketRegime.higher_timeframe ? (marketRegime.higher_timeframe.interval === 604800 ? '1W' : marketRegime.higher_timeframe.interval === 86400 ? '1D' : '4H') : '--'">
                                    --
                                </span>
                                <span class="text-xs px-2 py-1 rounded"
                                      :class="marketRegime.higher_timeframe && marketRegime.higher_timeframe.trend_direction === 'up' ? 
                                        'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                        marketRegime.higher_timeframe && marketRegime.higher_timeframe.trend_direction === 'down' ? 
                                        'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
                                        'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200'"
                                      x-text="marketRegime.higher_timeframe ? (marketRegime.higher_timeframe.trend_direction === 'up' ? '📈 上升趋势' : marketRegime.higher_timeframe.trend_direction === 'down' ? '📉 下降趋势' : '➡️ 震荡') : '--'">
                                    --
                                </span>
                            </div>
                        </template>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-gray-600 dark:text-gray-400"
                                  x-text="selectedInterval === '3600' ? '1H' : selectedInterval === '14400' ? '4H' : selectedInterval === '86400' ? '1D' : '1W'">
                                --
                            </span>
                            <span class="text-xs px-2 py-1 rounded"
                                  :class="marketRegime.trend_direction === 'up' ? 
                                    'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                                    marketRegime.trend_direction === 'down' ? 
                                    'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' : 
                                    'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'"
                                  x-text="marketRegime.trend_direction === 'up' ? '📈 上升' : marketRegime.trend_direction === 'down' ? '📉 下降' : '➡️ 震荡'">
                                --
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Current Trading Signal (Span 2 columns) -->
            <div class="lg:col-span-2" x-data="{ showBreakdown: false }">
                <template x-if="currentSignal">
                    <div class="rounded-lg shadow-lg p-6 border-l-4"
                         :class="currentSignal.signal_type === 'buy' ? 
                           'bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900 dark:to-green-800 border-green-500' : 
                           currentSignal.signal_type === 'sell' ? 
                           'bg-gradient-to-r from-red-50 to-red-100 dark:from-red-900 dark:to-red-800 border-red-500' :
                           'bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-800 dark:to-gray-700 border-gray-500'">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center">
                                        <span class="text-3xl mr-2" x-text="currentSignal.signal_type === 'buy' ? '✅' : currentSignal.signal_type === 'sell' ? '🔴' : '⏸️'">⏸️</span>
                                        <h3 class="text-xl font-bold"
                                            :class="currentSignal.signal_type === 'buy' ? 
                                              'text-green-800 dark:text-green-100' : 
                                              currentSignal.signal_type === 'sell' ?
                                              'text-red-800 dark:text-red-100' :
                                              'text-gray-800 dark:text-gray-100'"
                                            x-text="currentSignal.signal_type === 'buy' ? '买入信号' : currentSignal.signal_type === 'sell' ? '卖出信号' : '观望中 (HOLD)'">
                                            信号
                                        </h3>
                                    </div>
                                    
                                    <!-- Confidence -->
                                    <div class="text-right">
                                        <div class="text-2xl font-bold"
                                             :class="currentSignal.signal_type === 'buy' ? 
                                               'text-green-800 dark:text-green-100' : 
                                               currentSignal.signal_type === 'sell' ?
                                               'text-red-800 dark:text-red-100' :
                                               'text-gray-800 dark:text-gray-100'"
                                             x-text="currentSignal.confidence ? currentSignal.confidence.toFixed(0) + '%' : '--'">
                                            --
                                        </div>
                                        <div class="text-xs"
                                             :class="currentSignal.signal_type === 'buy' ? 
                                               'text-green-700 dark:text-green-300' : 
                                               currentSignal.signal_type === 'sell' ?
                                               'text-red-700 dark:text-red-300' :
                                               'text-gray-700 dark:text-gray-300'">
                                            置信度
                                        </div>
                                    </div>
                                </div>
                                <p class="text-sm"
                                   :class="currentSignal.signal_type === 'buy' ? 
                                     'text-green-700 dark:text-green-200' : 
                                     currentSignal.signal_type === 'sell' ?
                                     'text-red-700 dark:text-red-200' :
                                     'text-gray-700 dark:text-gray-200'">
                                    <span x-text="currentSignal.symbol">BTC/USD</span> @ 
                                    <span x-text="currentSignal.interval === 3600 ? '1H' : currentSignal.interval === 14400 ? '4H' : currentSignal.interval === 86400 ? '1D' : '1W'">1D</span>
                                    · <span x-text="new Date(currentSignal.timestamp).toLocaleString('zh-CN')">--</span>
                                </p>
                            </div>
                        </div>
                        
                        <!-- Strategy Details -->
                        <div class="bg-white dark:bg-gray-700 rounded p-4 mb-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">策略类型</div>
                                    <div class="text-sm font-semibold text-gray-900 dark:text-white"
                                         x-text="currentSignal.strategy === 'trend_follow' ? '📈 趋势跟随' : currentSignal.strategy === 'mean_reversion' ? '↔️ 均值回归' : currentSignal.strategy">
                                        --
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">入场价格</div>
                                    <div class="text-sm font-semibold"
                                         :class="currentSignal.signal_type === 'buy' ? 'text-green-600' : 'text-red-600'"
                                         x-text="currentSignal.entry_price ? '$' + currentSignal.entry_price.toFixed(2) : '--'">
                                        --
                                    </div>
                                </div>
                                <template x-if="currentSignal.stop_loss">
                                    <div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">止损价格</div>
                                        <div class="text-sm font-semibold text-red-600"
                                             x-text="'$' + currentSignal.stop_loss.toFixed(2) + ' (' + (currentSignal.risk_pct ? currentSignal.risk_pct.toFixed(1) + '%' : '') + ')'">
                                            --
                                        </div>
                                    </div>
                                </template>
                                <template x-if="currentSignal.take_profit">
                                    <div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">目标价格</div>
                                        <div class="text-sm font-semibold text-green-600"
                                             x-text="'$' + currentSignal.take_profit.toFixed(2) + ' (+' + (currentSignal.reward_pct ? currentSignal.reward_pct.toFixed(1) + '%' : '') + ')'">
                                            --
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <!-- Supporting Indicators -->
                        <div class="mb-4">
                            <div class="text-xs text-gray-600 dark:text-gray-300 mb-2">触发原因：</div>
                            <div class="text-xs text-gray-700 dark:text-gray-200" x-text="currentSignal.trigger_reason">--</div>
                        </div>
                        
                        <!-- Confidence Breakdown (Expandable) -->
                        <div class="mb-4 border-t border-gray-200 dark:border-gray-600 pt-4">
                            <button @click="showBreakdown = !showBreakdown" 
                                    class="w-full flex items-center justify-between text-sm font-semibold text-gray-800 dark:text-gray-200 hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                                <span>📊 置信度分析详情</span>
                                <svg class="w-5 h-5 transform transition-transform" :class="{ 'rotate-180': showBreakdown }"
                                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            
                            <div x-show="showBreakdown" x-transition:enter="transition ease-out duration-200"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-150"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95"
                                 class="mt-3 bg-gray-50 dark:bg-gray-800 rounded-lg p-4 space-y-3">
                                
                                <template x-if="currentSignal.confidence_breakdown">
                                    <div class="space-y-3">
                                        <!-- Base Score -->
                                        <div class="flex items-center justify-between text-sm">
                                            <span class="text-gray-600 dark:text-gray-400">基础分</span>
                                            <span class="font-semibold text-gray-900 dark:text-white" 
                                                  x-text="currentSignal.confidence_breakdown.base_score || '--'">--</span>
                                        </div>
                                        
                                        <!-- Adjustments -->
                                        <template x-if="currentSignal.confidence_breakdown.adjustments">
                                            <div class="space-y-2 border-l-2 border-blue-300 dark:border-blue-600 pl-3">
                                                <template x-for="(adj, key) in currentSignal.confidence_breakdown.adjustments" :key="key">
                                                    <div class="flex items-center justify-between text-xs">
                                                        <span class="text-gray-600 dark:text-gray-400" x-text="key"></span>
                                                        <span class="font-mono font-semibold"
                                                              :class="adj > 0 ? 'text-green-600 dark:text-green-400' : adj < 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-600'"
                                                              x-text="(adj > 0 ? '+' : '') + adj"></span>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                        
                                        <!-- Final Score -->
                                        <div class="flex items-center justify-between text-sm font-bold pt-2 border-t border-gray-300 dark:border-gray-600">
                                            <span class="text-gray-800 dark:text-gray-200">最终置信度</span>
                                            <span class="text-lg"
                                                  :class="currentSignal.signal_type === 'buy' ? 
                                                    'text-green-600 dark:text-green-400' : 
                                                    currentSignal.signal_type === 'sell' ?
                                                    'text-red-600 dark:text-red-400' :
                                                    'text-gray-600 dark:text-gray-400'"
                                                  x-text="(currentSignal.confidence_breakdown.final_score || 0) + '%'">--</span>
                                        </div>
                                        
                                        <!-- Metrics -->
                                        <template x-if="currentSignal.confidence_breakdown.metrics">
                                            <div class="mt-3 pt-3 border-t border-gray-300 dark:border-gray-600">
                                                <div class="text-xs font-semibold text-gray-700 dark:text-gray-300 mb-2">关键指标：</div>
                                                <div class="grid grid-cols-2 gap-2 text-xs">
                                                    <template x-for="(value, key) in currentSignal.confidence_breakdown.metrics" :key="key">
                                                        <div class="bg-white dark:bg-gray-700 rounded p-2">
                                                            <div class="text-gray-500 dark:text-gray-400 mb-1" x-text="key"></div>
                                                            <div class="font-mono font-semibold text-gray-900 dark:text-white" x-text="value"></div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                                
                                <template x-if="!currentSignal.confidence_breakdown">
                                    <div class="text-xs text-gray-500 dark:text-gray-400 text-center py-2">
                                        暂无详细分析数据
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </template>
                
                <!-- Hold Signal -->
                <template x-if="!currentSignal || currentSignal.signal_type === 'hold'">
                    <div class="bg-gray-100 dark:bg-gray-700 rounded-lg shadow p-6 border border-gray-300 dark:border-gray-600">
                        <div class="text-center">
                            <span class="text-4xl mb-2 block">⏸️</span>
                            <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">观望</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400">
                                当前无明确交易信号，建议等待更清晰的市场信号
                            </p>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Trading Charts -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- Price Chart -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Price Chart</h3>
                    <div class="flex items-center space-x-4">
                        <!-- Time Interval Selector - Button Group Style -->
                        <div class="flex items-center space-x-2">
                            <label class="text-sm text-gray-600 dark:text-gray-300">Interval:</label>
                            <div class="inline-flex rounded-lg border border-gray-200 dark:border-gray-600 overflow-hidden">
                                <button 
                                    @click="selectedInterval = '3600'; loadChartData()"
                                    :class="selectedInterval === '3600' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    1H
                                </button>
                                <button 
                                    @click="selectedInterval = '14400'; loadChartData()"
                                    :class="selectedInterval === '14400' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    4H
                                </button>
                                <button 
                                    @click="selectedInterval = '86400'; loadChartData()"
                                    :class="selectedInterval === '86400' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium border-r border-gray-200 dark:border-gray-600 last:border-r-0">
                                    1D
                                </button>
                                <button 
                                    @click="selectedInterval = '604800'; loadChartData()"
                                    :class="selectedInterval === '604800' ? 
                                        'bg-primary text-white' : 
                                        'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700'"
                                    class="px-3 py-1 text-sm font-medium">
                                    1W
                                </button>
                            </div>
                        </div>
                        <!-- Symbol Selector -->
                        <select x-model="selectedSymbol" @change="loadChartData()" 
                                class="rounded-md border-gray-300 text-sm focus:border-primary focus:ring-primary">
                            {% for symbol in symbols %}
                            <option value="{{ symbol.name }}">{{ symbol.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <!-- Main Price Chart -->
                <div class="h-64 mb-4">
                    <canvas id="priceChart"></canvas>
                </div>
                <!-- Volume Subplot -->
                <div class="h-24 border-t border-gray-200 dark:border-gray-600 pt-2">
                    <canvas id="volumeChart"></canvas>
                </div>
            </div>

            <!-- Indicators (Always visible - no login required) -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Technical Indicators</h3>
                <div class="space-y-4">
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">RSI (14)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.rsi || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">MACD</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.macd || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">SMA (20)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.sma_20 || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">EMA (12)</span>
                        <span class="text-sm font-bold text-gray-900 dark:text-white" x-text="indicators.ema_12 || '--'">--</span>
                    </div>
                    <!-- 轨道当值指标 -->
                    <div class="flex justify-between items-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg border border-blue-200 dark:border-blue-700">
                        <span class="text-sm font-medium text-blue-700 dark:text-blue-300">上轨当值 (EMA High)</span>
                        <span class="text-sm font-bold text-blue-900 dark:text-blue-100" x-text="indicators.ema_high_33 || '--'">--</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 dark:bg-red-900 rounded-lg border border-red-200 dark:border-red-700">
                        <span class="text-sm font-medium text-red-700 dark:text-red-300">下轨当值 (EMA Low)</span>
                        <span class="text-sm font-bold text-red-900 dark:text-red-100" x-text="indicators.ema_low_33 || '--'">--</span>
                    </div>
                    <!-- Last Closing Price with dynamic color based on EMA Channel position -->
                    <div class="flex justify-between items-center p-3 rounded-lg border-2"
                         :class="getClosingPriceColor()">
                        <span class="text-sm font-medium">
                            Last <span x-text="selectedInterval === '3600' ? '1H' : selectedInterval === '14400' ? '4H' : selectedInterval === '86400' ? '1D' : '1W'">1D</span> Closing
                        </span>
                        <span class="text-lg font-bold" x-text="lastClosePrice || '--'">--</span>
                    </div>
                    <div class="text-center py-2 mt-4">
                        <span class="text-xs text-gray-500 dark:text-gray-400" 
                              x-text="`Based on latest ${selectedSymbol} ${selectedInterval === '3600' ? '1H' : selectedInterval === '14400' ? '4H' : selectedInterval === '86400' ? '1D' : '1W'} data`">
                            Based on latest data
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6 border border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">System Status</h3>
            <div class="flex items-center space-x-4">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full mr-2" :class="wsConnected ? 'bg-green-500' : 'bg-red-500'"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">WebSocket</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Database</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                    <span class="text-sm text-gray-700 dark:text-gray-300">Redis</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        function tradingDashboard() {
            return {
                selectedSymbol: 'BTC/USD',
                selectedInterval: '86400', // Default to 1D
                livePrice: {},
                indicators: {},
                lastClosePrice: '--',
                wsConnected: false,
                priceChart: null,
                volumeChart: null,
                socket: null,
                // Market regime and trading signals data
                marketRegime: {},
                currentSignal: null,
                allSignals: [],
                // Symbol configuration (counter_decimals for price formatting)
                symbolsConfig: {{ symbols_config }},
                // Initial prices from server (with full precision)
                initialPrices: {{ initial_prices }},

            init() {
                this.initWebSocket();
                // V8: Chart initialization is in standalone script, but we trigger data load
                this.loadChartData();  // Load initial chart and indicators
                this.loadInitialPrices();
                this.loadMarketRegime();  // Load market regime
                this.loadTradingSignals();  // Load trading signals
            },

            async loadInitialPrices() {
                // Load prices from server-side data (using initialPrices to preserve precision)
                for (const [symbol, priceStr] of Object.entries(this.initialPrices)) {
                    const price = parseFloat(priceStr);
                    this.livePrice[symbol] = this.formatPrice(symbol, price);
                    console.log(`[Initial] ${symbol}: ${priceStr} → ${this.livePrice[symbol]}`);
                }
            },

                initWebSocket() {
                    try {
                        this.socket = new WebSocket(wsPath);
                        
                        this.socket.onopen = () => {
                            this.wsConnected = true;
                            // Subscribe to live price updates
                            this.socket.send(JSON.stringify({
                                event: "subscribe",
                                content: "ticker_price"
                            }));
                            this.socket.send(JSON.stringify({
                                event: "subscribe", 
                                content: "live_trades"
                            }));
                        };
                        
                        this.socket.onmessage = (event) => {
                            try {
                                // Check if data is JSON before parsing
                                if (typeof event.data !== 'string' || (!event.data.startsWith('{') && !event.data.startsWith('['))) {
                                    return;
                                }
                                
                                const data = JSON.parse(event.data);
                                this.updateLivePrice(data);
                            } catch (error) {
                                console.error('WebSocket error:', error);
                            }
                        };
                        
                        this.socket.onclose = () => {
                            this.wsConnected = false;
                            // Reconnect after 5 seconds
                            setTimeout(() => this.initWebSocket(), 5000);
                        };
                    } catch (error) {
                        console.error('WebSocket error:', error);
                    }
                },

                updateLivePrice(data) {
                    // Update live prices from WebSocket data
                    if (data.channel && data.data) {
                        // Handle live_trades_btcusd format
                        if (data.channel.startsWith('live_trades_')) {
                            const pairCode = data.channel.replace('live_trades_', '').toUpperCase();
                            // Convert pair codes to standard format
                            let symbol;
                            
                            // Map of special cases
                            const symbolMap = {
                                'BTCUSD': 'BTC/USD',
                                'ETHUSD': 'ETH/USD',
                                'ETHBTC': 'ETH/BTC',
                                'XRPUSD': 'XRP/USD',
                                'LTCUSD': 'LTC/USD',
                                'BCHUSD': 'BCH/USD',
                                'DOGEUSD': 'DOGE/USD',
                                'LINKUSD': 'LINK/USD',
                                'SOLUSD': 'SOL/USD'
                            };
                            
                            symbol = symbolMap[pairCode] || pairCode;
                            
                            const price = parseFloat(data.data.price_str || data.data.price);
                            const formatted = this.formatPrice(symbol, price);
                            console.log(`[WebSocket] ${pairCode} → ${symbol}: ${price} → ${formatted}`);
                            this.livePrice[symbol] = formatted;
                        }
                    }
                },

                getPriceChange(symbol) {
                    // Calculate price change percentage
                    // This would need historical data to calculate properly
                    return '+0.00%';
                },

                getPriceChangeClass(symbol) {
                    // Return CSS classes based on price change
                    return 'bg-gray-100 text-gray-800';
                },

                formatPrice(symbol, price) {
                    // Smart currency symbol formatting with dynamic decimals
                    if (!price || price === '--' || price === '') return '--';
                    
                    const numPrice = parseFloat(price.toString().replace(/[\$₿]/g, ''));
                    if (isNaN(numPrice)) return '--';
                    
                    // Get counter_decimals from config, default to 2
                    const config = this.symbolsConfig[symbol] || {};
                    const decimals = config.counter_decimals !== undefined ? config.counter_decimals : 2;
                    
                    // USD pairs get $ prefix
                    if (symbol.endsWith('/USD') || symbol === 'XAUUSD' || symbol === 'IAU' || symbol === 'TSLA') {
                        return '$' + numPrice.toFixed(decimals);
                    }
                    // BTC pairs get ₿ suffix  
                    else if (symbol.endsWith('/BTC')) {
                        return numPrice.toFixed(decimals) + ' ₿';
                    }
                    // Indices like DJI get no currency symbol
                    else if (symbol === 'DJI') {
                        return numPrice.toFixed(decimals);
                    }
                    // Default fallback (assume USD for stocks)
                    else {
                        return '$' + numPrice.toFixed(decimals);
                    }
                },
                
                getClosingPriceColor() {
                    // Determine color based on position relative to EMA Channel
                    // Parse numeric values from formatted strings
                    const parseValue = (val) => {
                        if (!val || val === '--') return null;
                        return parseFloat(val.toString().replace(/[\$₿,]/g, ''));
                    };
                    
                    const closePrice = parseValue(this.lastClosePrice);
                    const emaHigh = parseValue(this.indicators.ema_high_33);
                    const emaLow = parseValue(this.indicators.ema_low_33);
                    
                    // If any value is missing, use default gray
                    if (closePrice === null || emaHigh === null || emaLow === null) {
                        return 'bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300';
                    }
                    
                    // Above EMA High → Blue (matching upper rail)
                    if (closePrice > emaHigh) {
                        return 'bg-blue-50 dark:bg-blue-900 border-blue-300 dark:border-blue-700 text-blue-700 dark:text-blue-300';
                    }
                    // Below EMA Low → Red (matching lower rail)
                    else if (closePrice < emaLow) {
                        return 'bg-red-50 dark:bg-red-900 border-red-300 dark:border-red-700 text-red-700 dark:text-red-300';
                    }
                    // In between → Gray/Black
                    else {
                        return 'bg-gray-100 dark:bg-gray-700 border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white';
                    }
                },

                async loadChartData() {
                    try {
                        const response = await fetch(`/api/market-data/?symbol=${this.selectedSymbol}&interval=${this.selectedInterval}`);
                        const data = await response.json();

                        // Update indicators panel with dynamic decimals
                        if (data.indicators && data.indicators.length > 0) {
                            const latest = data.indicators[0];
                            const config = this.symbolsConfig[this.selectedSymbol] || {};
                            const decimals = config.counter_decimals !== undefined ? config.counter_decimals : 2;
                            
                            // Format with currency prefix based on symbol type
                            const formatIndicator = (value) => {
                                if (value === null || value === undefined) return '--';
                                if (this.selectedSymbol.endsWith('/USD')) {
                                    return '$' + Number(value).toFixed(decimals);
                                } else if (this.selectedSymbol.endsWith('/BTC')) {
                                    return Number(value).toFixed(decimals) + ' ₿';
                                } else {
                                    return Number(value).toFixed(decimals);
                                }
                            };
                            
                            this.indicators = {
                                rsi: (latest.rsi !== null && latest.rsi !== undefined) ? Number(latest.rsi).toFixed(2) : '--',
                                macd: (latest.macd !== null && latest.macd !== undefined) ? Number(latest.macd).toFixed(4) : '--',
                                sma_20: formatIndicator(latest.sma_20),
                                ema_12: formatIndicator(latest.ema_12),
                                ema_high_33: formatIndicator(latest.ema_high_33),
                                ema_low_33: formatIndicator(latest.ema_low_33)
                            };
                        } else {
                            this.indicators = { rsi: '--', macd: '--', sma_20: '--', ema_12: '--', ema_high_33: '--', ema_low_33: '--' };
                        }
                        
                        // Update last closing price with dynamic decimals
                        if (data.ohlc && data.ohlc.length > 0) {
                            const latestOhlc = data.ohlc[0]; // API returns newest first
                            this.lastClosePrice = this.formatPrice(this.selectedSymbol, latestOhlc.close);
                        } else {
                            this.lastClosePrice = '--';
                        }

                        // Update chart
                        if (typeof window.updatePriceChart === 'function') {
                            window.updatePriceChart(this.selectedSymbol, this.selectedInterval);
                        }
                        
                        // Also update market regime and trading signals when chart data changes
                        this.loadMarketRegime();
                        this.loadTradingSignals();
                    } catch (error) {
                        console.error('Error loading chart data:', error);
                    }
                },

                async loadMarketRegime() {
                    try {
                        const response = await fetch(`/api/market-regime/?symbol=${this.selectedSymbol}&interval=${this.selectedInterval}`);
                        const data = await response.json();
                        
                        if (!data.error) {
                            this.marketRegime = data;
                        } else {
                            this.marketRegime = {};
                        }
                    } catch (error) {
                        console.error('Error loading market regime:', error);
                        this.marketRegime = {};
                    }
                },

                async loadTradingSignals() {
                    try {
                        // Load current signal for selected symbol and interval
                        const response = await fetch(`/api/trading-signals/?symbol=${this.selectedSymbol}&interval=${this.selectedInterval}&status=active&limit=1`);
                        const data = await response.json();
                        
                        if (data.signals && data.signals.length > 0) {
                            this.currentSignal = data.signals[0];
                        } else {
                            this.currentSignal = null;
                        }
                        
                        // Load all active signals
                        const allResponse = await fetch(`/api/trading-signals/?status=active&limit=50`);
                        const allData = await allResponse.json();
                        this.allSignals = allData.signals || [];
                    } catch (error) {
                        console.error('Error loading trading signals:', error);
                        this.currentSignal = null;
                        this.allSignals = [];
                    }
                }
            }
        }
    </script>
</body>
</html>
